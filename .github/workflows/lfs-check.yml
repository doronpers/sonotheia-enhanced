# .github/workflows/lfs-check.yml
name: LFS Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  check-large-files:
    name: Check for large audio files and LFS usage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for non-LFS audio files over 1MB
        run: |
          echo "Scanning repository for large audio files not tracked by Git LFS..."
          AUDIO_EXTENSIONS=("wav" "flac" "mp3" "ogg" "m4a" "aac" "opus" "aiff" "wma" "au")
          NON_LFS_AUDIO=0

          # Find audio files >1MB; for each, verify it's tracked by LFS
          while IFS= read -r file; do
            if git lfs ls-files | grep -q -F "$file"; then
              echo "‚úì LFS: $file"
            else
              echo "‚ö†Ô∏è  Not LFS: $file"
              NON_LFS_AUDIO=$((NON_LFS_AUDIO + 1))
            fi
          done < <(find . -type f \( \
              -name "*.wav" -o -name "*.flac" -o -name "*.mp3" -o -name "*.ogg" -o \
              -name "*.m4a" -o -name "*.aac" -o -name "*.opus" -o -name "*.aiff" -o \
              -name "*.wma" -o -name "*.au" \
            \) -size +1M)

          if [ "$NON_LFS_AUDIO" -gt 0 ]; then
            echo "‚ö†  Found $NON_LFS_AUDIO audio file(s) larger than 1MB not tracked by Git LFS."
            echo "    Consider adding patterns to .gitattributes and re-adding files with LFS."
            exit 1
          else
            echo "‚úì No large non-LFS audio files detected."
          fi

      - name: Check Git LFS usage for changed audio files (PRs)
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking changed audio files in this PR for LFS tracking..."
          BASE_BRANCH="${{ github.base_ref }}"
          git fetch origin "$BASE_BRANCH"
          CHANGED_FILES=$(git diff --name-only "origin/$BASE_BRANCH"...HEAD)

          AUDIO_EXTENSIONS=("wav" "flac" "mp3" "ogg" "m4a" "aac" "opus" "aiff")
          FOUND_AUDIO=0

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [ -f "$file" ]; then
              ext="${file##*.}"
              ext_lower=$(echo "$ext" | tr '[:upper:]' '[:lower:]')
              for audio_ext in "${AUDIO_EXTENSIONS[@]}"; do
                if [ "$ext_lower" = "$audio_ext" ]; then
                  FOUND_AUDIO=1
                  echo "üìÅ Audio file detected: $file"
                  if git lfs ls-files | grep -q -F "$file"; then
                    echo "   ‚úì Tracked by Git LFS"
                  else
                    echo "   ‚ö†Ô∏è  NOT tracked by Git LFS - consider adding to LFS"
                    # Fail CI if audio is not tracked to enforce policy
                    exit 1
                  fi
                fi
              done
            fi
          done <<< "$CHANGED_FILES"

          if [ "$FOUND_AUDIO" -eq 0 ]; then
            echo "No audio files found in this PR."
          fi

          echo "‚úì LFS check complete"

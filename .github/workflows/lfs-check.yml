name: LFS Check

on:
  pull_request:
    branches: [ main ]

jobs:
  check-large-files:
    name: Check for Large Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to compare with base branch
      
      - name: Check for large files
        run: |
          echo "Checking for files larger than 100MB..."
          echo ""
          
          # Get the base branch (main)
          BASE_BRANCH="${{ github.base_ref }}"
          
          # Get list of changed files in this PR
          git fetch origin "$BASE_BRANCH"
          CHANGED_FILES=$(git diff --name-only "origin/$BASE_BRANCH"...HEAD)
          
          # Track if we find any large files
          FOUND_LARGE_FILES=0
          MAX_SIZE_MB=100
          MAX_SIZE_BYTES=$((MAX_SIZE_MB * 1024 * 1024))
          
          echo "Changed files in this PR:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Check each file
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc)
              
              if [ "$size" -gt "$MAX_SIZE_BYTES" ]; then
                echo "‚ùå LARGE FILE DETECTED: $file (${size_mb} MB)"
                FOUND_LARGE_FILES=1
              elif [ "$size" -gt $((50 * 1024 * 1024)) ]; then
                # Warn about files larger than 50MB but less than 100MB
                echo "‚ö†Ô∏è  Large file: $file (${size_mb} MB) - consider using Git LFS"
              fi
            fi
          done <<< "$CHANGED_FILES"
          
          echo ""
          
          if [ "$FOUND_LARGE_FILES" -eq 1 ]; then
            echo "================================"
            echo "‚ùå ERROR: Large files detected!"
            echo "================================"
            echo ""
            echo "Files larger than ${MAX_SIZE_MB}MB should be tracked with Git LFS."
            echo ""
            echo "To fix this:"
            echo "1. Install Git LFS: https://git-lfs.github.com/"
            echo "2. Run: git lfs install"
            echo "3. Track your large files: git lfs track '*.wav' '*.mp3' etc."
            echo "4. Add .gitattributes: git add .gitattributes"
            echo "5. Remove large files from Git history:"
            echo "   git rm --cached <large-file>"
            echo "   git add <large-file>  # This will now use LFS"
            echo "   git commit --amend"
            echo ""
            echo "Common audio file patterns are already configured in .gitattributes"
            echo ""
            exit 1
          else
            echo "‚úì No large files detected. All files are under ${MAX_SIZE_MB}MB."
            echo ""
            echo "Note: Audio files (*.wav, *.flac, *.mp3) should use Git LFS."
            echo "Check .gitattributes for configured LFS patterns."
          fi
      
      - name: Check Git LFS usage for audio files
        run: |
          echo "Checking for audio files that should use Git LFS..."
          echo ""
          
          # Get the base branch
          BASE_BRANCH="${{ github.base_ref }}"
          
          # Get list of changed files
          git fetch origin "$BASE_BRANCH"
          CHANGED_FILES=$(git diff --name-only "origin/$BASE_BRANCH"...HEAD)
          
          # Audio file extensions that should use LFS
          AUDIO_EXTENSIONS=("wav" "flac" "mp3" "ogg" "m4a" "aac" "opus" "aiff")
          
          # Check for audio files
          FOUND_AUDIO=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              ext="${file##*.}"
              ext_lower=$(echo "$ext" | tr '[:upper:]' '[:lower:]')
              
              for audio_ext in "${AUDIO_EXTENSIONS[@]}"; do
                if [ "$ext_lower" = "$audio_ext" ]; then
                  FOUND_AUDIO=1
                  echo "üìÅ Audio file detected: $file"
                  
                  # Check if file is tracked by LFS
                  if git lfs ls-files | grep -q "$file"; then
                    echo "   ‚úì Tracked by Git LFS"
                  else
                    echo "   ‚ö†Ô∏è  NOT tracked by Git LFS - consider adding to LFS"
                  fi
                fi
              done
            fi
          done <<< "$CHANGED_FILES"
          
          if [ "$FOUND_AUDIO" -eq 0 ]; then
            echo "No audio files found in this PR."
          fi
          
          echo ""
          echo "‚úì LFS check complete"

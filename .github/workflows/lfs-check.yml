name: LFS Check

on:
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  check-large-files:
    name: Check for large files
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check for large files
      run: |
        echo "Checking for files larger than 100MB..."
        
        # Function to get file size (cross-platform)
        get_file_size() {
          stat -f%z "$1" 2>/dev/null || stat -c%s "$1" 2>/dev/null || echo 0
        }
        
        # Get the base branch
        BASE_BRANCH="${{ github.base_ref }}"
        
        # Find files changed in this PR
        git diff --name-only origin/$BASE_BRANCH...HEAD > changed_files.txt
        
        # Check size of each changed file
        LARGE_FILES=0
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            SIZE=$(get_file_size "$file")
            SIZE_MB=$((SIZE / 1048576))
            if [ $SIZE_MB -gt 100 ]; then
              echo "❌ Large file detected: $file (${SIZE_MB}MB)"
              LARGE_FILES=$((LARGE_FILES + 1))
            fi
          fi
        done < changed_files.txt
        
        if [ $LARGE_FILES -gt 0 ]; then
          echo ""
          echo "❌ Found $LARGE_FILES file(s) larger than 100MB."
          echo "Please use Git LFS to track large files:"
          echo "  git lfs install"
          echo "  git lfs track '*.wav' '*.flac' '*.mp3'"
          echo "  git add .gitattributes"
          echo ""
          echo "For audio files, ensure they are listed in .gitattributes with LFS tracking."
          exit 1
        else
          echo "✅ No large files detected. All files are under 100MB."
        fi
    
    - name: Check for audio files not tracked by LFS
      run: |
        echo "Checking for audio files that should be tracked by Git LFS..."
        
        # Function to get file size (cross-platform)
        get_file_size() {
          stat -f%z "$1" 2>/dev/null || stat -c%s "$1" 2>/dev/null || echo 0
        }
        
        # Get the base branch
        BASE_BRANCH="${{ github.base_ref }}"
        
        # Find audio files changed in this PR
        git diff --name-only --diff-filter=A origin/$BASE_BRANCH...HEAD | \
          grep -E '\.(wav|flac|mp3|ogg|aac|m4a)$' > audio_files.txt || true
        
        if [ -s audio_files.txt ]; then
          echo "Audio files detected:"
          cat audio_files.txt
          
          # Check if they are tracked by LFS
          NON_LFS_AUDIO=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              # Check if file is tracked by LFS
              if ! git lfs ls-files | grep -q "$file"; then
                SIZE=$(get_file_size "$file")
                SIZE_KB=$((SIZE / 1024))
                if [ $SIZE_KB -gt 1024 ]; then
                  echo "⚠️  Audio file not tracked by LFS: $file (${SIZE_KB}KB)"
                  NON_LFS_AUDIO=$((NON_LFS_AUDIO + 1))
                fi
              fi
            fi
          done < audio_files.txt
          
          if [ $NON_LFS_AUDIO -gt 0 ]; then
            echo ""
            echo "⚠️  Found $NON_LFS_AUDIO audio file(s) larger than 1MB not tracked by Git LFS."
            echo "Consider using Git LFS for these files to keep the repository size manageable."
            echo ""
            echo "To track audio files with LFS:"
            echo "  git lfs install"
            echo "  git lfs track '*.wav' '*.flac' '*.mp3'"
            echo "  git add .gitattributes"
            echo "  git add <audio-files>"
            echo "  git commit -m 'Track audio files with LFS'"
          fi
        else
          echo "✅ No audio files detected in this PR."
        fi
